<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--tg-theme-bg-color, #212d3b);
      color: var(--tg-theme-text-color, #f0f0f0);
      padding: 20px 16px;
      min-height: 100vh;
    }

    h1 { font-size: 17px; font-weight: 600; margin-bottom: 20px; }

    .drop-zone {
      background-color: var(--tg-theme-secondary-bg-color, #1c2533);
      border: 2px dashed var(--tg-theme-hint-color, #5f7285);
      border-radius: 14px;
      padding: 36px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background-color .2s;
      user-select: none;
    }
    .drop-zone.dragover {
      border-color: var(--tg-theme-button-color, #2ea6ff);
      background-color: rgba(46,166,255,.08);
    }
    .drop-zone input[type="file"] { display: none; }
    .drop-zone .icon { font-size: 38px; margin-bottom: 10px; }
    .drop-zone .label { font-size: 15px; font-weight: 500; }
    .drop-zone .hint {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #5f7285);
      margin-top: 6px;
    }

    .selected-file {
      margin-top: 14px;
      padding: 12px 14px;
      background-color: var(--tg-theme-secondary-bg-color, #1c2533);
      border-radius: 10px;
      display: none;
    }
    .selected-file .name { font-size: 14px; font-weight: 500; word-break: break-all; }
    .selected-file .size {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #5f7285);
      margin-top: 3px;
    }

    .progress-wrap { margin-top: 14px; display: none; }
    .progress-track {
      height: 4px;
      background-color: var(--tg-theme-secondary-bg-color, #1c2533);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%; width: 0;
      background-color: var(--tg-theme-button-color, #2ea6ff);
      border-radius: 2px;
      transition: width .2s;
    }
    .progress-text {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #5f7285);
      margin-top: 6px;
      text-align: center;
    }

    .btn {
      display: block; width: 100%;
      padding: 14px; margin-top: 16px;
      background-color: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff);
      border: none; border-radius: 12px;
      font-size: 15px; font-weight: 600;
      cursor: pointer; transition: opacity .15s;
    }
    .btn:disabled { opacity: .45; cursor: not-allowed; }
    .btn:not(:disabled):active { opacity: .8; }

    .status {
      margin-top: 14px; font-size: 14px;
      text-align: center; padding: 10px;
      border-radius: 10px; display: none;
    }
    .status.error  { background: rgba(229,57,53,.12); color: #e53935; display: block; }
    .status.success{ background: rgba(67,160,71,.12);  color: #43a047; display: block; }
  </style>
</head>
<body>
  <h1>üó∫ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h1>

  <div class="drop-zone" id="dropZone">
    <input type="file" id="fileInput" accept=".zip">
    <div class="icon">üìÅ</div>
    <div class="label">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª</div>
    <div class="hint">–¢–æ–ª—å–∫–æ .zip ¬∑ –ª—é–±–æ–π —Ä–∞–∑–º–µ—Ä</div>
  </div>

  <div class="selected-file" id="selectedFile">
    <div class="name" id="fileName"></div>
    <div class="size" id="fileSize"></div>
  </div>

  <div class="progress-wrap" id="progressWrap">
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-text" id="progressText"></div>
  </div>

  <button class="btn" id="uploadBtn" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <div class="status" id="status"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const dropZone      = document.getElementById('dropZone');
    const fileInput     = document.getElementById('fileInput');
    const selectedFileEl= document.getElementById('selectedFile');
    const fileNameEl    = document.getElementById('fileName');
    const fileSizeEl    = document.getElementById('fileSize');
    const progressWrap  = document.getElementById('progressWrap');
    const progressFill  = document.getElementById('progressFill');
    const progressText  = document.getElementById('progressText');
    const uploadBtn     = document.getElementById('uploadBtn');
    const statusEl      = document.getElementById('status');

    let selectedFile = null;

    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => { if (e.target.files[0]) selectFile(e.target.files[0]); });

    dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', ()  => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('dragend',   ()  => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files[0]) selectFile(e.dataTransfer.files[0]);
    });

    function selectFile(file) {
      if (!file.name.toLowerCase().endsWith('.zip')) {
        showStatus('‚ùå –ù—É–∂–µ–Ω .zip —Ñ–∞–π–ª', 'error');
        return;
      }
      selectedFile = file;
      fileNameEl.textContent = file.name;
      fileSizeEl.textContent = fmtSize(file.size);
      selectedFileEl.style.display = 'block';
      uploadBtn.disabled = false;
      clearStatus();
      progressWrap.style.display = 'none';
      progressFill.style.width = '0';
    }

    uploadBtn.addEventListener('click', () => {
      if (!selectedFile) return;
      uploadBtn.disabled = true;
      clearStatus();
      progressWrap.style.display = 'block';

      const fd = new FormData();
      fd.append('save', selectedFile, selectedFile.name);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      xhr.setRequestHeader('X-Telegram-Init-Data', tg.initData);

      xhr.upload.addEventListener('progress', e => {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded / e.total * 100);
          progressFill.style.width = pct + '%';
          progressText.textContent = pct + '%  ¬∑  ' + fmtSize(e.loaded) + ' / ' + fmtSize(e.total);
        }
      });

      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          progressFill.style.width = '100%';
          showStatus('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ /restart', 'success');
          setTimeout(() => tg.close(), 3000);
        } else {
          showStatus('‚ùå –û—à–∏–±–∫–∞ ' + xhr.status + ': ' + xhr.responseText, 'error');
          uploadBtn.disabled = false;
        }
      });

      xhr.addEventListener('error', () => {
        showStatus('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', 'error');
        uploadBtn.disabled = false;
      });

      xhr.send(fd);
    });

    function fmtSize(b) {
      return b < 1024 * 1024
        ? (b / 1024).toFixed(1) + ' KB'
        : (b / 1024 / 1024).toFixed(1) + ' MB';
    }
    function showStatus(msg, cls) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + cls;
    }
    function clearStatus() { statusEl.className = 'status'; }
  </script>
</body>
</html>
