package telegram

import (
	"context"
	"fmt"
	"io"
	"log"
	"net/http"
	"strings"
	"time"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

func (b *Bot) handleUpdate(update tgbotapi.Update) {
	if update.Message == nil {
		return
	}

	userID := update.Message.From.ID
	chatID := update.Message.Chat.ID

	if !b.isAllowedUser(userID) {
		b.reply(chatID, "â›” ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°")
		return
	}

	if update.Message.Document != nil {
		b.handleUploadSave(chatID, update.Message.Document)
		return
	}

	if !update.Message.IsCommand() {
		return
	}

	args := update.Message.CommandArguments()

	switch update.Message.Command() {

	case "start", "help":
		b.handleHelp(chatID)

	case "status":
		b.handleStatus(chatID)

	case "players":
		b.handlePlayers(chatID)

	case "cmd":
		b.handleCmd(chatID, args)

	case "msg":
		b.handleMsg(chatID, args)

	case "save":
		b.handleSave(chatID)

	case "time":
		b.handleTime(chatID)

	case "evolution":
		b.handleEvolution(chatID)

	case "restart":
		b.handleRestart(chatID)

	case "stop":
		b.handleStopServer(chatID)

	case "startServer":
		b.handleStartServer(chatID)

	case "getPassword":
		b.handleGetPassword(chatID)

	case "uploadSave":
		b.reply(chatID, "ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ zip-Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ğ¾Ñ‚ Ñ‡Ğ°Ñ‚.")

	case "downloadSave":
		b.handleDownloadSave(chatID)
	}
}

// â”€â”€ help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleHelp(chatID int64) {
	b.reply(chatID, `ğŸ­ Factorio Bot

/status â€” ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
/players â€” Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½
/cmd <ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°> â€” RCON ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°
/msg <Ñ‚ĞµĞºÑÑ‚> â€” ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ñ‡Ğ°Ñ‚ Ğ¸Ğ³Ñ€Ñ‹
/save â€” Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
/time â€” Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ¸Ğ³Ñ€Ğµ
/evolution â€” ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞ²Ğ¾Ğ»ÑÑ†Ğ¸Ğ¸
/restart â€” Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· RCON (Docker restart policy)

/stop â€” Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
/startServer â€” Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€

/getPassword â€” Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ RCON Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
/downloadSave â€” ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
/uploadSave â€” Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ (Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ zip-Ñ„Ğ°Ğ¹Ğ»)`)
}

// â”€â”€ server status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleStatus(chatID int64) {
	b.reply(chatID, fmt.Sprintf("Ğ¡ĞµÑ€Ğ²ĞµÑ€: %s", b.status.Check()))
}

// â”€â”€ players â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handlePlayers(chatID int64) {
	resp, err := b.rcon.Execute("/players online")
	if err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	if strings.TrimSpace(resp) == "" {
		b.reply(chatID, "ğŸ˜´ ĞĞµÑ‚ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½")
	} else {
		b.reply(chatID, "ğŸ‘¥ "+resp)
	}
}

// â”€â”€ cmd â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleCmd(chatID int64, args string) {
	if args == "" {
		b.reply(chatID, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: /cmd <ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°>")
		return
	}
	resp, err := b.rcon.Execute(args)
	if err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	if strings.TrimSpace(resp) == "" {
		b.reply(chatID, "âœ… Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾")
	} else {
		b.reply(chatID, resp)
	}
}

// â”€â”€ msg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleMsg(chatID int64, args string) {
	if args == "" {
		b.reply(chatID, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: /msg <Ñ‚ĞµĞºÑÑ‚>")
		return
	}
	if _, err := b.rcon.Execute("/say " + args); err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	b.reply(chatID, "âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾")
}

// â”€â”€ save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleSave(chatID int64) {
	if _, err := b.rcon.Execute("/server-save"); err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	b.reply(chatID, "ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾")
}

// â”€â”€ time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleTime(chatID int64) {
	resp, err := b.rcon.Execute("/time")
	if err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	b.reply(chatID, "â± "+resp)
}

// â”€â”€ evolution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleEvolution(chatID int64) {
	resp, err := b.rcon.Execute("/evolution")
	if err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	b.reply(chatID, "ğŸ¦  "+resp)
}

// â”€â”€ restart (RCON /quit, Docker auto-restart) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleRestart(chatID int64) {
	b.reply(chatID, "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ ÑĞµÑ€Ğ²ĞµÑ€...")
	_, _ = b.rcon.Execute("/quit")
	time.Sleep(3 * time.Second)
	b.reply(chatID, "âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° (Docker restart policy Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€)")
}

// â”€â”€ stop container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleStopServer(chatID int64) {
	b.reply(chatID, "â¹ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€...")
	if err := b.container.Stop(context.Background()); err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	b.reply(chatID, "âœ… ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")
}

// â”€â”€ start container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleStartServer(chatID int64) {
	b.reply(chatID, "â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€...")
	if err := b.container.Start(context.Background()); err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}
	b.reply(chatID, "âœ… ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½")
}

// â”€â”€ getPassword â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleGetPassword(chatID int64) {
	pw := b.passwords.Get()
	if pw == "" {
		b.reply(chatID, "âŒ ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğµ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")
		return
	}
	b.reply(chatID, "ğŸ”‘ RCON Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ: `"+pw+"`")
}

// â”€â”€ download save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleDownloadSave(chatID int64) {
	b.reply(chatID, "ğŸ“¦ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ»Ñ Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ...")

	name, data, err := b.saves.LatestSave()
	if err != nil {
		b.reply(chatID, "âŒ "+err.Error())
		return
	}

	b.replyDocument(chatID, name, data)
}

// â”€â”€ upload save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) handleUploadSave(chatID int64, doc *tgbotapi.Document) {
	if !strings.HasSuffix(strings.ToLower(doc.FileName), ".zip") {
		b.reply(chatID, "âŒ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ .zip Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ")
		return
	}

	b.reply(chatID, "ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ñ„Ğ°Ğ¹Ğ»...")

	data, err := b.downloadTelegramFile(doc.FileID)
	if err != nil {
		b.reply(chatID, "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: "+err.Error())
		return
	}

	if err := b.saves.Replace(doc.FileName, data); err != nil {
		b.reply(chatID, "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸: "+err.Error())
		return
	}

	b.reply(chatID, fmt.Sprintf("âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Â«%sÂ» Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ.", doc.FileName))
}

// â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

func (b *Bot) downloadTelegramFile(fileID string) ([]byte, error) {
	fileConfig := tgbotapi.FileConfig{FileID: fileID}
	file, err := b.api.GetFile(fileConfig)
	if err != nil {
		return nil, fmt.Errorf("getting file info: %w", err)
	}

	url := file.Link(b.api.Token)
	resp, err := http.Get(url) //nolint:gosec
	if err != nil {
		return nil, fmt.Errorf("downloading file: %w", err)
	}
	defer resp.Body.Close()

	data, err := io.ReadAll(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("reading response body: %w", err)
	}

	log.Printf("downloaded file %s: %d bytes", fileID, len(data))
	return data, nil
}
